rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && (request.auth.token.email == 'monyauseotsanyana7@gmail.com' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Removed unused function

    function isCompany() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'company';
    }

    function isInstitution() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'institution';
    }

    function isStudent() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
    }

    function isGraduate() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'graduate';
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated();
    }

    // Institutions collection
    match /institutions/{institutionId} {
      allow read: if true; // Public read for browsing
      allow write: if isInstitution() && request.auth.uid == institutionId || isAdmin();
    }

    // Faculties collection
    match /faculties/{facultyId} {
      allow read: if true;
      allow write: if isInstitution() || isAdmin();
    }

    // Courses collection
    match /courses/{courseId} {
      allow read: if true; // Public read for browsing
      allow write: if isInstitution() && resource.data.institutionId == request.auth.uid || isAdmin();
      allow create: if isInstitution();
    }

    // Applications collection
    match /applications/{applicationId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.studentId ||
        (isInstitution() && resource.data.institutionId == request.auth.uid) ||
        isAdmin()
      );
      allow write: if isAuthenticated() && (
        request.auth.uid == resource.data.studentId ||
        (isInstitution() && resource.data.institutionId == request.auth.uid) ||
        isAdmin()
      );
      allow create: if isStudent();
    }

    // Admissions collection
    match /admissions/{admissionId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.studentId ||
        (isInstitution() && resource.data.institutionId == request.auth.uid) ||
        isAdmin()
      );
      allow write: if isInstitution() && resource.data.institutionId == request.auth.uid || isAdmin();
    }

    // Jobs collection
    match /jobs/{jobId} {
      allow read: if true; // Public read for browsing
      allow write: if isCompany() && resource.data.companyId == request.auth.uid || isAdmin();
      allow create: if isCompany();
    }

    // Job Applications collection
    match /job_applications/{applicationId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.graduateId ||
        (isCompany() && resource.data.companyId == request.auth.uid) ||
        isAdmin()
      );
      allow write: if isAuthenticated() && (
        request.auth.uid == resource.data.graduateId ||
        (isCompany() && resource.data.companyId == request.auth.uid) ||
        isAdmin()
      );
      allow create: if isGraduate();
    }

    // Companies collection
    match /companies/{companyId} {
      allow read: if true; // Public read for browsing
      allow write: if isCompany() && request.auth.uid == companyId || isAdmin();
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId || isAdmin();
      allow write: if isAuthenticated() && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if isAuthenticated();
    }

    // Documents collection
    match /documents/{documentId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        (isInstitution() && resource.data.institutionId == request.auth.uid) ||
        (isCompany() && resource.data.companyId == request.auth.uid) ||
        isAdmin()
      );
      allow write: if isAuthenticated() && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if isAuthenticated();
    }

    // Analytics collection
    match /analytics/{analyticsId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
      allow create: if isAuthenticated(); // Allow creation for logging, but read only admin
    }
  }
}
